diff --git a/drivers/usb/core/config.c b/drivers/usb/core/config.c
index 8fc4497..873c861 100644
--- a/drivers/usb/core/config.c
+++ b/drivers/usb/core/config.c
@@ -830,10 +830,12 @@
 	for (i = 0; i < num; i++) {
 		buffer += length;
 		cap = (struct usb_dev_cap_header *)buffer;
-		length = cap->bLength;
 
-		if (total_len < length)
+		if (total_len < sizeof(*cap) || total_len < cap->bLength) {
+			dev->bos->desc->bNumDeviceCaps = i;
 			break;
+		}
+		length = cap->bLength;
 		total_len -= length;
 
 		if (cap->bDescriptorType != USB_DT_DEVICE_CAPABILITY) {
